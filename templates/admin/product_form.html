{% extends "base.html" %}

{% block title %}{{ title }} - Nepal Meat Shop{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-{{ 'plus' if 'Add' in title else 'edit' }} me-2"></i>
                    {{ title }}
                </h5>
            </div>

            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    {{ form.hidden_tag() }}

                    <!-- Basic Information -->
                    <h6 class="mb-3 text-primary">
                        <i class="fas fa-info-circle me-2"></i>
                        Basic Information
                    </h6>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.name.label(class="form-label") }}
                            {{ form.name(class="form-control" + (" is-invalid" if form.name.errors else "")) }}
                            {% if form.name.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.name.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            {{ form.name_nepali.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.name_nepali(class="form-control", id="name_nepali", placeholder="Type in English and it will convert to Nepali") }}
                                <button type="button" class="btn btn-outline-secondary" onclick="translateToNepali()" title="Auto-translate from English name">
                                    <i class="fas fa-language"></i>
                                </button>
                            </div>
                            <small class="form-text text-muted">
                                Type English words (e.g., "sungur", "khasi", "buff") and they will auto-convert to Nepali
                            </small>
                            {% if form.name_nepali.errors %}
                                {% for error in form.name_nepali.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        {{ form.description.label(class="form-label") }}
                        {{ form.description(class="form-control" + (" is-invalid" if form.description.errors else ""), rows="4") }}
                        {% if form.description.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.description.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Category and Type -->
                    <h6 class="mb-3 text-primary mt-4">
                        <i class="fas fa-tags me-2"></i>
                        Category & Type
                    </h6>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            {{ form.category_id.label(class="form-label") }}
                            {{ form.category_id(class="form-select" + (" is-invalid" if form.category_id.errors else "")) }}
                            {% if form.category_id.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.category_id.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-4 mb-3">
                            {{ form.meat_type.label(class="form-label") }}
                            {{ form.meat_type(class="form-select" + (" is-invalid" if form.meat_type.errors else "")) }}
                            {% if form.meat_type.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.meat_type.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-4 mb-3">
                            {{ form.preparation_type.label(class="form-label") }}
                            {{ form.preparation_type(class="form-select" + (" is-invalid" if form.preparation_type.errors else "")) }}
                            {% if form.preparation_type.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.preparation_type.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Pricing and Inventory -->
                    <h6 class="mb-3 text-primary mt-4">
                        <i class="fas fa-dollar-sign me-2"></i>
                        Pricing & Inventory
                    </h6>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            {{ form.price.label(class="form-label") }}
                            <div class="input-group">
                                <span class="input-group-text">रू</span>
                                {{ form.price(class="form-control", type="number", step="0.01", min="1", placeholder="Enter price per kg" + (" is-invalid" if form.price.errors else "")) }}
                                <span class="input-group-text">/kg</span>
                            </div>
                            {% if form.price.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.price.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-4 mb-3">
                            {{ form.stock_kg.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.stock_kg(class="form-control", type="number", step="0.1", min="0", placeholder="Enter stock in kg" + (" is-invalid" if form.stock_kg.errors else "")) }}
                                <span class="input-group-text">kg</span>
                            </div>
                            {% if form.stock_kg.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.stock_kg.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-4 mb-3">
                            {{ form.min_order_kg.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.min_order_kg(class="form-control", type="number", step="0.1", min="0.1", placeholder="Enter minimum order in kg" + (" is-invalid" if form.min_order_kg.errors else "")) }}
                                <span class="input-group-text">kg</span>
                            </div>
                            {% if form.min_order_kg.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.min_order_kg.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Freshness and Tips -->
                    <h6 class="mb-3 text-primary mt-4">
                        <i class="fas fa-leaf me-2"></i>
                        Freshness & Tips
                    </h6>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.freshness_hours.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.freshness_hours(class="form-control", type="number", min="1", max="72", placeholder="Enter freshness in hours (1-72)" + (" is-invalid" if form.freshness_hours.errors else "")) }}
                                <span class="input-group-text">hours</span>
                            </div>
                            {% if form.freshness_hours.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.freshness_hours.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Hours since processing/cutting</div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <div class="form-check mt-4">
                                {{ form.is_featured(class="form-check-input") }}
                                {{ form.is_featured.label(class="form-check-label") }}
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        {{ form.cooking_tips.label(class="form-label") }}
                        {{ form.cooking_tips(class="form-control" + (" is-invalid" if form.cooking_tips.errors else ""), rows="3") }}
                        {% if form.cooking_tips.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.cooking_tips.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">Tips for cooking this meat (optional)</div>
                    </div>

                    <!-- Image Upload -->
                    <h6 class="mb-3 text-primary mt-4">
                        <i class="fas fa-image me-2"></i>
                        Product Image
                    </h6>

                    <!-- Current Image Display (for editing) -->
                    {% if product and product.image_url %}
                    <div class="mb-3">
                        <label class="form-label">Current Image:</label>
                        <div>
                            <img src="{{ url_for('main.uploaded_file', filename=product.image_url) }}" 
                                 alt="{{ product.name }}" 
                                 class="img-thumbnail" 
                                 style="max-width: 200px;">
                        </div>
                        <div class="form-text text-muted">Upload a new image to replace the current one</div>
                    </div>
                    {% endif %}

                    <div class="mb-3">
                        {{ form.image.label(class="form-label") }}
                        {{ form.image(class="form-control" + (" is-invalid" if form.image.errors else "")) }}
                        {% if form.image.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.image.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">Upload a high-quality image of the product (JPG, PNG, GIF)</div>
                    </div>

                    <!-- Preview Area -->
                    <div id="imagePreview" class="mb-3" style="display: none;">
                        <label class="form-label">Preview:</label>
                        <div>
                            <img id="previewImg" src="" alt="Preview" class="img-thumbnail" style="max-width: 200px;">
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="{{ url_for('admin.admin_products') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>
                            Cancel
                        </a>

                        <div>
                            <button type="reset" class="btn btn-outline-warning me-2">
                                <i class="fas fa-undo me-2"></i>
                                Reset
                            </button>
                            {{ form.submit(class="btn btn-primary") }}
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Image preview functionality
document.getElementById('image').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('previewImg').src = e.target.result;
            document.getElementById('imagePreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        document.getElementById('imagePreview').style.display = 'none';
    }
});

// Form validation enhancements
document.querySelector('form').addEventListener('submit', function(e) {
    const price = parseFloat(document.getElementById('price').value);
    const stock = parseFloat(document.getElementById('stock_kg').value);
    const minOrder = parseFloat(document.getElementById('min_order_kg').value);

    if (minOrder > stock) {
        e.preventDefault();
        alert('Minimum order quantity cannot be greater than available stock!');
        return false;
    }

    if (price <= 0) {
        e.preventDefault();
        alert('Price must be greater than 0!');
        return false;
    }
});

// Auto-calculate freshness label
document.getElementById('freshness_hours').addEventListener('change', function() {
    const hours = parseInt(this.value);
    let label = '';

    if (hours <= 6) {
        label = 'Fresh Today (आज ताजा)';
    } else if (hours <= 24) {
        label = 'Cut Yesterday (हिजो काटिएको)';
    } else {
        label = 'Stock (स्टक)';
    }

    // Show the label (you could add a display element for this)
    console.log('Freshness label:', label);
});

// English to Nepali meaningful translation mapping
const englishToNepali = {
    // Animals and meat types
    'pork': 'सुँगुरको मासु',
    'pig': 'सुँगुर',
    'sungur': 'सुँगुर',
    'buffalo': 'भैंसीको मासु',
    'buff': 'भैंसी',
    'goat': 'बाख्राको मासु',
    'khasi': 'खसी',
    'mutton': 'खसीको मासु',
    'chicken': 'कुखुराको मासु',
    'duck': 'हाँसको मासु',
    'fish': 'माछा',
    'lamb': 'भेडाको मासु',
    'beef': 'गाईको मासु',
    'turkey': 'टर्कीको मासु',

    // Body parts and cuts (meaningful translations)
    'leg': 'खुट्टा',
    'thigh': 'तिघ्रा',
    'shoulder': 'काँध',
    'neck': 'घाँटी',
    'back': 'ढाड',
    'belly': 'पेट',
    'chest': 'छाती',
    'breast': 'छाती',
    'wing': 'पखेटा',
    'ribs': 'करङ',
    'tail': 'पुच्छर',
    'head': 'टाउको',
    'liver': 'कलेजो',
    'kidney': 'मिर्गौला',
    'heart': 'मुटु',
    'tongue': 'जिब्रो',
    'brain': 'दिमाग',
    'feet': 'खुट्टा',
    'hand': 'हात',
    'arm': 'हात',
    'foreleg': 'अगाडिको खुट्टा',
    'hind leg': 'पछाडिको खुट्टा',
    'front leg': 'अगाडिको खुट्टा',
    'back leg': 'पछाडिको खुट्टा',

    // Preparation and cooking terms
    'fresh': 'ताजा',
    'frozen': 'जमेको',
    'dried': 'सुकेको',
    'smoked': 'धुवाँमा पकाएको',
    'grilled': 'ग्रिल गरिएको',
    'roasted': 'भुटेको',
    'fried': 'भुटेको',
    'boiled': 'उमालेको',
    'steamed': 'बाफमा पकाएको',
    'raw': 'काँचो',
    'cooked': 'पकाएको',
    'marinated': 'मसलामा राखेको',
    'seasoned': 'मसला हालेको',
    'spiced': 'मसलेदार',
    'tender': 'नरम',
    'tough': 'कडा',
    'lean': 'बोसो नभएको',
    'fatty': 'बोसो भएको',

    // Cuts and preparation styles
    'chop': 'चप',
    'steak': 'स्टेक',
    'fillet': 'फिलेट',
    'slice': 'टुक्रा',
    'chunk': 'ठूलो टुक्रा',
    'mince': 'किमा',
    'ground': 'पिसेको',
    'diced': 'साना टुक्रामा काटिएको',
    'cubed': 'घनाकार काटिएको',
    'strips': 'लामो टुक्रा',
    'whole': 'पूरो',
    'half': 'आधा',
    'quarter': 'चौथाई',
    'boneless': 'हड्डीरहित',
    'with bone': 'हड्डी सहित',
    'bone in': 'हड्डी सहित',
    'skinless': 'छाला नभएको',
    'with skin': 'छाला सहित',

    // Quality and freshness
    'premium': 'उत्कृष्ट',
    'quality': 'गुणस्तर',
    'organic': 'जैविक',
    'local': 'स्थानीय',
    'imported': 'आयातित',
    'farm': 'फार्म',
    'free range': 'खुला चरन',
    'grass fed': 'घाँस खाएको',
    'natural': 'प्राकृतिक',
    'healthy': 'स्वस्थ',
    'nutritious': 'पोषक',

    // Common descriptive words
    'meat': 'मासु',
    'food': 'खाना',
    'protein': 'प्रोटिन',
    'bone': 'हड्डी',
    'fat': 'बोसो',
    'skin': 'छाला',
    'blood': 'रगत',
    'juice': 'रस',
    'gravy': 'झोल',
    'curry': 'तरकारी',
    'soup': 'सूप',
    'stew': 'स्ट्यू',

    // Measurements and quantities
    'kg': 'केजी',
    'kilogram': 'किलोग्राम',
    'gram': 'ग्राम',
    'pound': 'पाउन्ड',
    'ounce': 'आउन्स',
    'piece': 'टुक्रा',
    'pieces': 'टुक्राहरू',
    'pack': 'प्याकेट',
    'packet': 'प्याकेट',
    'box': 'बक्स',
    'bag': 'झोला',

    // Common adjectives
    'big': 'ठूलो',
    'small': 'सानो',
    'large': 'ठूलो',
    'medium': 'मध्यम',
    'thick': 'बाक्लो',
    'thin': 'पातलो',
    'long': 'लामो',
    'short': 'छोटो',
    'wide': 'चौडा',
    'narrow': 'साँघुरो',
    'hot': 'तातो',
    'cold': 'चिसो',
    'warm': 'न्यानो',
    'cool': 'चिसो',
    'spicy': 'तीतो',
    'mild': 'हल्का',
    'sweet': 'मिठो',
    'sour': 'अमिलो',
    'bitter': 'तितो',
    'salty': 'नुनिलो',

    // Prepositions and connectors
    'with': 'सहित',
    'without': 'बिना',
    'and': 'र',
    'or': 'वा',
    'of': 'को',
    'in': 'मा',
    'on': 'मा',
    'for': 'को लागि',
    'from': 'बाट',
    'to': 'लाई',

    // Special meat shop terms
    'special': 'विशेष',
    'today': 'आज',
    'daily': 'दैनिक',
    'weekly': 'साप्ताहिक',
    'monthly': 'मासिक',
    'offer': 'अफर',
    'discount': 'छुट',
    'sale': 'बिक्री',
    'price': 'मूल्य',
    'cost': 'लागत',
    'cheap': 'सस्तो',
    'expensive': 'महँगो',
    'affordable': 'किफायती',
    'best': 'सबैभन्दा राम्रो',
    'good': 'राम्रो',
    'excellent': 'उत्कृष्ट',
    'perfect': 'उत्तम'
};

function translateToNepali() {
    const englishName = document.getElementById('name').value.toLowerCase().trim();
    const nepaliField = document.getElementById('name_nepali');

    if (!englishName) {
        alert('Please enter English name first');
        return;
    }

    let translated = englishName;

    // Sort keys by length (longer phrases first) to handle multi-word translations
    const sortedKeys = Object.keys(englishToNepali).sort((a, b) => b.length - a.length);

    // Replace phrases and words with their Nepali equivalents
    for (const english of sortedKeys) {
        // Create regex that matches whole words/phrases with word boundaries
        const escapedEnglish = english.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp('\\b' + escapedEnglish + '\\b', 'gi');
        translated = translated.replace(regex, englishToNepali[english]);
    }

    // Clean up extra spaces and format properly
    translated = translated.replace(/\s+/g, ' ').trim();

    // Capitalize first letter if it's English
    if (translated && /^[a-zA-Z]/.test(translated)) {
        translated = translated.charAt(0).toUpperCase() + translated.slice(1);
    }

    nepaliField.value = translated;

    // Show success message
    if (translated !== englishName) {
        // Temporarily show success feedback
        const button = event.target;
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check text-success"></i>';
        button.classList.add('btn-success');
        button.classList.remove('btn-outline-secondary');
        
        setTimeout(() => {
            button.innerHTML = originalHTML;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
        }, 1500);
    } else {
        // Show that no translation was found
        const button = event.target;
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-question text-warning"></i>';
        button.classList.add('btn-warning');
        button.classList.remove('btn-outline-secondary');
        
        setTimeout(() => {
            button.innerHTML = originalHTML;
            button.classList.remove('btn-warning');
            button.classList.add('btn-outline-secondary');
        }, 1500);
    }
}

// Auto-transliterate on typing (only for complete words)
document.getElementById('name_nepali').addEventListener('input', function(e) {
    const input = e.target.value;
    const words = input.toLowerCase().split(/\s+/);
    let translated = input;
    let hasTranslation = false;

    // Only translate if the user has finished typing a word (ends with space or common punctuation)
    if (input.endsWith(' ') || input.endsWith(',') || input.endsWith('.')) {
        // Sort keys by length (longer phrases first)
        const sortedKeys = Object.keys(englishToNepali).sort((a, b) => b.length - a.length);
        
        for (const english of sortedKeys) {
            // Only replace complete words with word boundaries
            const escapedEnglish = english.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp('\\b' + escapedEnglish + '\\b', 'gi');
            if (regex.test(translated.toLowerCase())) {
                translated = translated.replace(regex, englishToNepali[english]);
                hasTranslation = true;
            }
        }

        if (hasTranslation) {
            // Clean up extra spaces
            translated = translated.replace(/\s+/g, ' ');
            e.target.value = translated;
        }
    }
});
</script>
{% endblock %}