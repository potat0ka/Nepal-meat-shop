{% extends "base.html" %}

{% block title %}Order Management - Nepal Meat Shop{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="fas fa-shopping-cart me-2"></i>
                Order Management
            </h2>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary" onclick="refreshOrders()">
                    <i class="fas fa-sync-alt me-2"></i>
                    Refresh
                </button>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-download me-2"></i>
                        Export
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="exportOrdersPDF()">
                            <i class="fas fa-file-pdf me-2 text-danger"></i>Export as PDF
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportOrdersCSV()">
                            <i class="fas fa-file-csv me-2 text-success"></i>Export as CSV
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Filter Controls -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-3">
                        <label for="statusFilter" class="form-label">Status Filter</label>
                        <select class="form-select" id="statusFilter" onchange="filterOrders()">
                            <option value="">All Orders</option>
                            <option value="pending">Pending</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="processing">Processing</option>
                            <option value="out_for_delivery">Out for Delivery</option>
                            <option value="delivered">Delivered</option>
                            <option value="cod_paid">COD Paid</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label for="dateFilter" class="form-label">Date Filter</label>
                        <select class="form-select" id="dateFilter" onchange="filterOrders()">
                            <option value="">All Dates</option>
                            <option value="today">Today</option>
                            <option value="yesterday">Yesterday</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="searchOrders" class="form-label">Search</label>
                        <input type="text" class="form-control" id="searchOrders" 
                               placeholder="Search by order number, customer name..." onkeyup="filterOrders()">
                    </div>
                    
                    <div class="col-md-2">
                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                            <i class="fas fa-times me-2"></i>
                            Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        {% if orders %}
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Orders ({{ orders|length }})</h6>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="ordersTable">
                    <thead class="table-dark">
                        <tr>
                            <th>Order #</th>
                            <th>Customer</th>
                            <th>Items</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Payment</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr data-status="{{ order.status }}" data-date="{{ order.created_at.isoformat() if order.created_at else '' }}">
                            <td>
                                <strong>#{{ order.order_number }}</strong>
                                {% if order.special_instructions %}
                                <br>
                                <small class="text-info">
                                    <i class="fas fa-comment" title="Has special instructions"></i>
                                </small>
                                {% endif %}
                            </td>
                            
                            <td>
                                <div>
                                    <strong>{{ order.user.full_name }}</strong>
                                    <br>
                                    <small class="text-muted">{{ order.user.email }}</small>
                                    <br>
                                    <small class="text-muted">
                                        <i class="fas fa-phone me-1"></i>{{ order.delivery_phone }}
                                    </small>
                                </div>
                            </td>
                            
                            <td>
                                <span class="badge bg-info">{{ order.order_items|length }} items</span>
                                <br>
                                <small class="text-muted">
                                    {% for item in order.order_items[:2] %}
                                    {{ item.product.name }}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                    {% if order.order_items|length > 2 %}...{% endif %}
                                </small>
                            </td>
                            
                            <td>
                                <strong class="text-primary">रू {{ "%.0f"|format(order.total_amount) }}</strong>
                                <br>
                                <small class="text-muted">{{ order.payment_method.upper() }}</small>
                            </td>
                            
                            <td>
                                <select class="form-select form-select-sm status-select" 
                                        data-order-id="{{ order._id }}" 
                                        onchange="updateOrderStatus(this)">
                                    <option value="pending" {% if order.status == 'pending' %}selected{% endif %}>Pending</option>
                                    <option value="confirmed" {% if order.status == 'confirmed' %}selected{% endif %}>Confirmed</option>
                                    <option value="processing" {% if order.status == 'processing' %}selected{% endif %}>Processing</option>
                                    <option value="out_for_delivery" {% if order.status == 'out_for_delivery' %}selected{% endif %}>Out for Delivery</option>
                                    <option value="delivered" {% if order.status == 'delivered' %}selected{% endif %}>Delivered</option>
                                    <option value="cod_paid" {% if order.status == 'cod_paid' %}selected{% endif %}>COD Paid</option>
                                    <option value="cancelled" {% if order.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                                </select>
                            </td>
                            
                            <td>
                                <span class="badge bg-{{ 'success' if order.payment_status == 'paid' else ('warning' if order.payment_status == 'pending' else 'danger') }}">
                                    {{ order.payment_status.title() }}
                                </span>
                            </td>
                            
                            <td>
                                <div>
                                    {{ order.created_at.strftime('%b %d') if order.created_at else 'N/A' }}
                            <br>
                            <small class="text-muted">{{ order.created_at.strftime('%I:%M %p') if order.created_at else '' }}</small>
                                </div>
                            </td>
                            
                            <td>
                                <div class="btn-group" role="group">
                                    <a href="{{ url_for('admin.order_detail', order_id=order._id) }}" 
                                       class="btn btn-outline-primary btn-sm" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    
                                    <button class="btn btn-outline-info btn-sm" 
                                            title="Print Order" onclick="printOrder('{{ order._id }}')">
                                        <i class="fas fa-print"></i>
                                    </button>
                                    
                                    {% if order.status not in ['delivered', 'cod_paid', 'cancelled'] %}
                                    <button class="btn btn-outline-success btn-sm" 
                                            title="Send Notification" onclick="sendNotification('{{ order._id }}')">
                                        <i class="fas fa-bell"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-shopping-cart fa-5x text-muted mb-4"></i>
            <h4>No orders found</h4>
            <p class="text-muted">Orders will appear here when customers place them</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
function updateOrderStatus(selectElement) {
    const orderId = selectElement.dataset.orderId;
    const newStatus = selectElement.value;
    const oldStatus = selectElement.dataset.oldStatus || 'pending';
    
    if (confirm(`Update order status to "${newStatus.replace('_', ' ').toUpperCase()}"?`)) {
        fetch(`/admin/orders/${orderId}/update-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Store new status for future reference
                selectElement.dataset.oldStatus = newStatus;
                
                // Update row styling based on status
                const row = selectElement.closest('tr');
                row.setAttribute('data-status', newStatus);
                
                // Update status badge
                const statusBadge = row.querySelector('.badge');
                if (statusBadge) {
                    statusBadge.textContent = newStatus.replace('_', ' ').toUpperCase();
                    statusBadge.className = `badge bg-${getStatusColor(newStatus)}`;
                }
                
                showToast(data.message, 'success');
            } else {
                // Revert selection on error
                selectElement.value = oldStatus;
                showToast(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Revert selection on error
            selectElement.value = oldStatus;
            showToast('Error updating order status', 'danger');
        });
    } else {
        // Revert selection if user cancels
        selectElement.value = oldStatus;
    }
}

function filterOrders() {
    const statusFilter = document.getElementById('statusFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;
    const searchTerm = document.getElementById('searchOrders').value.toLowerCase();
    const rows = document.querySelectorAll('#ordersTable tbody tr');
    
    rows.forEach(row => {
        let showRow = true;
        
        // Status filter
        if (statusFilter && row.dataset.status !== statusFilter) {
            showRow = false;
        }
        
        // Search filter
        if (searchTerm) {
            const orderNumber = row.cells[0].textContent.toLowerCase();
            const customerName = row.cells[1].textContent.toLowerCase();
            
            if (!orderNumber.includes(searchTerm) && !customerName.includes(searchTerm)) {
                showRow = false;
            }
        }
        
        // Date filter (simplified - would need more complex logic for real implementation)
        if (dateFilter) {
            const orderDate = new Date(row.dataset.date);
            const today = new Date();
            
            switch(dateFilter) {
                case 'today':
                    if (orderDate.toDateString() !== today.toDateString()) {
                        showRow = false;
                    }
                    break;
                // Add other date filter logic here
            }
        }
        
        row.style.display = showRow ? '' : 'none';
    });
}

function clearFilters() {
    document.getElementById('statusFilter').value = '';
    document.getElementById('dateFilter').value = '';
    document.getElementById('searchOrders').value = '';
    filterOrders();
}

function refreshOrders() {
    location.reload();
}

function exportOrdersPDF() {
    // Show loading state
    showToast('Generating PDF export...', 'info');
    
    // Get current status filter if any
    const statusFilter = document.getElementById('statusFilter').value;
    let exportUrl = '{{ url_for("admin.export_orders") }}';
    if (statusFilter) {
        exportUrl += '?status=' + encodeURIComponent(statusFilter);
    }
    
    // Create a temporary link to trigger download
    const link = document.createElement('a');
    link.href = exportUrl;
    link.download = '';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Show success message after a short delay
    setTimeout(() => {
        showToast('PDF export completed!', 'success');
    }, 1000);
}

function exportOrdersCSV() {
    // Show loading state
    showToast('Generating CSV export...', 'info');
    
    // Get current status filter if any
    const statusFilter = document.getElementById('statusFilter').value;
    let exportUrl = '{{ url_for("admin.export_orders_csv") }}';
    if (statusFilter) {
        exportUrl += '?status=' + encodeURIComponent(statusFilter);
    }
    
    // Create a temporary link to trigger download
    const link = document.createElement('a');
    link.href = exportUrl;
    link.download = '';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Show success message after a short delay
    setTimeout(() => {
        showToast('CSV export completed!', 'success');
    }, 1000);
}

// Legacy function for backward compatibility
function exportOrders() {
    exportOrdersPDF();
}

function printOrder(orderId) {
    // Open admin order detail page in new window for printing
    window.open(`/admin/orders/${orderId}`, '_blank');
}

function sendNotification(orderId) {
    if (confirm('Send status update notification to customer?')) {
        fetch(`/admin/orders/${orderId}/send-notification`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
            } else {
                showToast(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error sending notification', 'danger');
        });
    }
}

function getCSRFToken() {
    const token = document.querySelector('meta[name="csrf-token"]');
    return token ? token.getAttribute('content') : '';
}

function getStatusColor(status) {
    const statusColors = {
        'pending': 'warning',
        'confirmed': 'info',
        'processing': 'primary',
        'out_for_delivery': 'secondary',
        'delivered': 'success',
        'cancelled': 'danger'
    };
    return statusColors[status] || 'secondary';
}

function showToast(message, type = 'info') {
    // Simple toast notification (would use a proper toast library in production)
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 5000);
}
</script>
{% endblock %}
